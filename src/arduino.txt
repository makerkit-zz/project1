//超声波智能避障车程序（ARDUINO）包括蓝牙控制和超声波控制切换，加速、减速控制、以及防撞车倒车控制
//    L = 左
//    R = 右
//    F = 前
//    B = 後
 
#include <Servo.h> 
unsigned char flag;
unsigned int H_speed=100;
int pinLB=3;     // 定x6_位 左後
int pinLF=5;     // 定x9_位 左前
 
int pinRB=6;    // 定x10_位 右後
int pinRF=11;    // 定x11_位 右前
 
int inputPin = A0;  // 定x超音波信接收_位
int outputPin =A1;  // 定x超音波信l射_位
 
int Fspeedd = 0;      // 前速
int Rspeedd = 0;      // 右速
int Lspeedd = 0;      // 左速
int directionn = 0;   // 前=8 後=2 左=4 右=6 
Servo myservo;        // O myservo
int delay_time = 250; // 伺服R_D向後的定rg
 
int Fgo = 8;         // 前M
int Rgo = 6;         // 右D
int Lgo = 4;         // 左D
int Bgo = 2;         // 倒
char temp;
void advance(int a)     // 前M
    {
     analogWrite(pinRB,H_speed);  // 使R_（右後）幼
     analogWrite(pinRF,0);
     analogWrite(pinLB,H_speed);  // 使R_（左後）幼
     analogWrite(pinLF,0);
     delay(a * 20);     
    }
void turnR(int d)        //右D(p)
    {
     analogWrite(pinRB,0);  //使R_（右後）幼
     analogWrite(pinRF,H_speed);
     analogWrite(pinLB,H_speed);
     analogWrite(pinLF,0);  //使R_（左前）幼
     delay(d *5);
    }
void turnL(int e)        //左D(p)
    {
     analogWrite(pinRB,H_speed);
     analogWrite(pinRF,0);   //使R_（右前）幼
     analogWrite(pinLB,0);   //使R_（左後）幼
     analogWrite(pinLF,H_speed);
     delay(e * 5);
    }    
void stopp(int f)         //停止
    {
     analogWrite(pinRB,0);
     analogWrite(pinRF,0);
     analogWrite(pinLB,0);
     analogWrite(pinLF,0);
     delay(f * 20);
    }
     
void back(int g)          //後退
    {
     analogWrite(pinRB,0);  //使R_（右後）幼
     analogWrite(pinRF,H_speed);
     analogWrite(pinLB,0);  //使R_（左後）幼
     analogWrite(pinLF,H_speed);
     delay(g * 20);     
    }
     
void detection()        //y量3角度(0.90.179)
    {      
      int delay_time = 250;   // 伺服R_D向後的定rg
      ask_pin_F();            // x取前方距x   
      if(Fspeedd <40)         // 假如前方距x小於25公分
      {
        ask_pin_L();            // x取左方距x
        delay(delay_time);      // 等待伺服R_定
        ask_pin_R();            // x取右方距x  
        delay(delay_time);      // 等待伺服R_定  
        if(Lspeedd < 20 && Rspeedd <20)   //假如 左距x和右距x皆小於10公分
        {
         directionn = Bgo;      //向後走        
        }
        else
        {
          if(Lspeedd > Rspeedd)   //假如 左距x大於右距x
          {
           directionn = Rgo;      //向右走
          }
           
          if(Lspeedd <= Rspeedd)   //假如 左距x小於或等於右距x
          {
           directionn = Lgo;      //向左走
          } 
        }                          
      }
      else                      //加如前方不小於(大於)25公分     
      {
        directionn = Fgo;        //向前走     
      }
      
    }    
void ask_pin_F()   // 量出前方距x 
    {
      myservo.write(90);
      digitalWrite(outputPin, LOW);   // 超波l射低2μs
      delayMicroseconds(2);
      digitalWrite(outputPin, HIGH);  // 超波l射高10μs，@e至少是10μs
      delayMicroseconds(10);
      digitalWrite(outputPin, LOW);    // S持超波l射低
      float Fdistance = pulseIn(inputPin, HIGH);  // x差相差rg
      Fdistance= Fdistance/5.8/10;       // rgD榫嚯x距离（挝唬汗分）
      Serial.print("F distance:");      //出距x（挝唬汗分）
      Serial.println(Fdistance);         //@示距x
      Fspeedd = Fdistance;              // ⒕嚯x x入Fspeedd(前速)
    }  
 void ask_pin_L()   // 量出左距x 
    {
      myservo.write(5);
      delay(delay_time);
      digitalWrite(outputPin, LOW);   // 超波l射低2μs
      delayMicroseconds(2);
      digitalWrite(outputPin, HIGH);  // 超波l射高10μs，@e至少是10μs
      delayMicroseconds(10);
      digitalWrite(outputPin, LOW);    // S持超波l射低
      float Ldistance = pulseIn(inputPin, HIGH);  // x差相差rg
      Ldistance= Ldistance/5.8/10;       // rgD榫嚯x距离（挝唬汗分）
      Serial.print("L distance:");       //出距x（挝唬汗分）
      Serial.println(Ldistance);         //@示距x
      Lspeedd = Ldistance;              // ⒕嚯x x入Lspeedd(左速)
    }  
void ask_pin_R()   // 量出右距x 
    {
      myservo.write(177);
      delay(delay_time);
      digitalWrite(outputPin, LOW);   // 超波l射低2μs
      delayMicroseconds(2);
      digitalWrite(outputPin, HIGH);  // 超波l射高10μs，@e至少是10μs
      delayMicroseconds(10);
      digitalWrite(outputPin, LOW);    // S持超波l射低
      float Rdistance = pulseIn(inputPin, HIGH);  // x差相差rg
      Rdistance= Rdistance/5.8/10;       // rgD榫嚯x距离（挝唬汗分）
      Serial.print("R distance:");       //出距x（挝唬汗分）
      Serial.println(Rdistance);         //@示距x
      Rspeedd = Rdistance;              // ⒕嚯x x入Rspeedd(右速)
    }  
     
void stop()
{
     analogWrite(pinRB,0);  //使R_（右後）幼
     analogWrite(pinRF,0);
     analogWrite(pinLB,0);  //使R_（左後）幼
     analogWrite(pinLF,0);
}
 
void csb()
{
    myservo.write(90);  //伺服R_回w A湮恢 湎乱淮蔚y量
    detection();        //y量角度 K且判嘁往哪一方向移
       
   if(directionn == 2)  //假如directionn(方向) = 2(倒)             
   {
     back(15);                    //  倒退()
     turnL(10);                   //些微向左方移(防止卡在死巷e)
     Serial.print(" Reverse ");   //@示方向(倒退)
   }
   if(directionn == 6)           //假如directionn(方向) = 6(右D)    
   {
     back(1); 
     turnR(20);                   // 右D
     Serial.print(" Right ");    //@示方向(左D)
     ask_pin_F();
   }
   if(directionn == 4)          //假如directionn(方向) = 4(左D)    
   {  
     back(1);      
     turnL(20);                  // 左D
     Serial.print(" Left ");     //@示方向(右D) 
     ask_pin_F();  
   }  
   if(directionn == 8)          //假如directionn(方向) = 8(前M)      
   { 
    advance(1);                 // 正常前M   
    Serial.print(" Advance ");   //@示方向(前M)
    Serial.print("   ");    
   }
}
 
void setup()
 {
  Serial.begin(9600);     // 定xR_出_位 
  pinMode(pinLB,OUTPUT); // _位 8 (PWM)
  pinMode(pinLF,OUTPUT); // _位 9 (PWM)
  pinMode(pinRB,OUTPUT); // _位 10 (PWM) 
  pinMode(pinRF,OUTPUT); // _位 11 (PWM)
   
  pinMode(inputPin, INPUT);    // 定x超音波入_位
  pinMode(outputPin, OUTPUT);  // 定x超音波出_位   
 
  myservo.attach(10);    // 定x伺服R_出第10_位(PWM)
  delay(1000);
  char val = Serial.read();
  if(val == 'B'| val == 'b')
  {
      flag = 1;
      Serial.println("blue tooth!");
  }
  else
  {
      flag = 0;
      Serial.println("csb!");
  }
 }
     
void loop()
 {
     delay(500);
     char vat = Serial.read();
     if(vat == 'b'| vat == 'B')
     {
         flag = 1;
         stop();
         Serial.println("blue tooth!");
     }
     else if(vat == 't'| vat == 'T')
    {
        flag = 0;
        stop();
        Serial.println("csb!");
    }
    if(vat == '+')
    {
      if(H_speed<240)
      {
        H_speed+=10;
      }
    }
    else if(vat == '-')
    {
      if(H_speed>15)
      {
        H_speed-=10;
      }
    }
     if(flag == 1)
     {
        myservo.write(90);  //伺服R_回w A湮恢 湎乱淮蔚y量   
        ask_pin_F();
        if('W' == vat || 'w' == vat|| 'A' == vat|| 'a' == vat|| 's' == vat|| 'S' == vat|| 'd' == vat|| 'D' == vat)      
        {
          temp=vat;
        }
          if('W' == temp || 'w' == temp)
          {
            ask_pin_F();
            if(Fspeedd>30)
            {
              advance(1);
              Serial.println("GO!");
            }
            else
            {
              stop();
              Serial.println("I'm will hit obstacles!");
            }
          }
          else if('A' == temp | 'a' == temp)
          {
             turnR(6); 
             Serial.println("Left");
           }
          else if('D' == temp | 'd' == temp)
          {
             turnL(6);
             Serial.println("Right");
          }
          else if('S' == temp | 's' == temp)
         { 
           back(1);
           Serial.println("Back");
         }
        else if('Q' == temp | 'q' == temp)
        {
           stop();
           Serial.println("Stop!");
        }  
     }
     else
     {
         stop();
         csb();
     }
 }